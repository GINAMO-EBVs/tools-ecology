<tool id="vcf_filtering_heterozygosity" name="VCF filtering : heterozygosity" version="0.1.0" python_template_version="3.5">
    <requirements>
        <requirement type="package" version="1.22">bcftools</requirement>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[
        mkdir -p vcf_filtered_directory &&
        mkdir -p summary &&

        bash '$__tool_directory__/VCF_filtering_heterozygosity.sh'
            '${vcf_input}'
            '${vcf_input.element_identifier}'
            '$MAX_Ho'
    ]]></command>

    <inputs>
        <param name="vcf_input" type="data" format="vcf" label="Upload your VCF file"
            help="File containing SNP data in VCF format. You can upload a simple file, multiple file or a dataset collection"/>
        <param name="MAX_Ho" type="float" min="0" max="1" label="Maximum observed heterozygosity value per SNP"
            help="Maximum proportion of observed heterozygotes allowed to retain a variant."/>
    </inputs>

    <outputs>
        <data name="vcf_filtered" format="vcf" label="${tool.name}">
                <discover_datasets pattern="(?P&lt;designation&gt;.+)\.vcf$" directory="vcf_filtered_directory" visible="true" assign_primary_output="true"/>
        </data>
        <data name="SNPs" from_work_dir="summary/n_snps.tabular" format="tabular" label="Filtering on heterozygosity : Number of SNPs"/>
    </outputs>

    <tests>
        <test>
            <param name="vcf_input" value="test_vcf.vcf"/>
            <param name="MAX_Ho" value="0.6"/>
            <output name="vcf_filtered" file="vcf_filtered_directory/test_vcf_Ho.vcf" count="1"/>
            <output name="SNPs" file="summary/n_snps.tabular"/>
        </test>
    </tests>

    <help><![CDATA[
Usage
=====
As input, the user provides one or more VCF files (Danecek *et al.* 2011) and a threshold value indicating a maximum value for the observed heterozygosity per SNP.

For each input VCF file, the tool calculates the proportion of heterozygous genotypes for each SNP and removes those with a value strictly above the user-defined threshold in the outpout file.

Example : if MAX_Ho = 0.6, all SNP with an observed heterozygosity above 60% in the input dataset are removed from the output VCF file.

Tips
====

Threshold values for observed heterozygosity help identify technical artifacts. Loci with an observed heterozygosity greater than 0.6 are likely to be more or less divergent paralogous loci due to duplication events rather than single loci (McKinney *et al.* 2017).

See also examples of VCF formats in :  https://samtools.github.io/hts-specs/VCFv4.5.pdf    
        
    ]]></help>

    <citations>
        <citation type="bibtex">
        @article{10.1093/gigascience/giab008,
    author = {Danecek, Petr and Bonfield, James K and Liddle, Jennifer and Marshall, John and Ohan, Valeriu and Pollard, Martin O and Whitwham, Andrew and Keane, Thomas and McCarthy, Shane A and Davies, Robert M and Li, Heng},
    title = "{Twelve years of SAMtools and BCFtools}",
    journal = {GigaScience},
    volume = {10},
    number = {2},
    year = {2021},
    abstract = "{SAMtools and BCFtools are widely used programs for processing and analysing high-throughput sequencing data. They include tools for file format conversion and manipulation, sorting, querying, statistics, variant calling, and effect analysis amongst other methods.The first version appeared online 12 years ago and has been maintained and further developed ever since, with many new features and improvements added over the years. The SAMtools and BCFtools packages represent a unique collection of tools that have been used in numerous other software projects and countless genomic pipelines.Both SAMtools and BCFtools are freely available on GitHub under the permissive MIT licence, free for both non-commercial and commercial use. Both packages have been installed \\&gt;1 million times via Bioconda. The source code and documentation are available from https://www.htslib.org.}",
    issn = {2047-217X},
    doi = {10.1093/gigascience/giab008},
    url = {https://doi.org/10.1093/gigascience/giab008},
    note = {giab008},
    eprint = {https://academic.oup.com/gigascience/article-pdf/10/2/giab008/36332246/giab008.pdf},
        }
        </citation>

        <citation type="bibtex">
            @article{McKinney2017,
  title        = {Paralogs are revealed by proportion of heterozygotes and deviations in read ratios in genotyping-by-sequencing data from natural populations},
  author       = {McKinney, Garrett J. and Waples, Ryan K. and Seeb, Lisa W. and Seeb, James E.},
  journal      = {Molecular Ecology Resources},
  volume       = {17},
  number       = {4},
  pages        = {656--669},
  year         = {2017},
  doi          = {10.1111/1755-0998.12613},
}
        </citation>
        <citation type="bibtex">
            @article{Danecek2011,
  author          = {Danecek, Petr and Auton, Adam and Abecasis, Goncalo and Albers, Cornelis A. and Banks, Erica and DePristo, Mark A. and Handsaker, Robert E. and Lunter, Gerton and Marth, Gabor T. and Sherry, Stephen T. and McVean, Gil and Durbin, Richard and {1000 Genomes Project Analysis Group}},
  title           = {The variant call format and {VCF}tools},
  journal         = {Bioinformatics},
  volume          = {27},
  number          = {15},
  pages           = {2156-2158},
  year            = {2011},
  doi             = {10.1093/bioinformatics/btr330},
  URL             = {https://doi.org/10.1093/bioinformatics/btr330},
  eprint          = {https://academic.oup.com/bioinformatics/article-pdf/27/15/2156/600788/btr330.pdf},
}
        </citation>
    <citation type="bibtex">
        @manual{VCFv45,
  title        = {The Variant Call Format (VCF) Specification, Version 4.5},
  author       = {{HTS-specs team}},
  organization = {Global Alliance for Genomics and Health},
  year         = {2024},
  url          = {https://samtools.github.io/hts-specs/VCFv4.5.pdf},
  note         = {Accessed: 2025-02-11}
}
    </citation>
    </citations>
        
</tool>