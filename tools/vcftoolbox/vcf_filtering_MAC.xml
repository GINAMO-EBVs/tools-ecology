<tool id="vcf_filtering_MAC" name="VCF filtering : Minor allele count" version="0.1.0" python_template_version="3.5">
    <requirements>
        <requirement type="package" version="1.22">bcftools</requirement>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[
        mkdir -p vcf_filtered_directory &&
        mkdir -p summary &&
        
        bash '$__tool_directory__/vcf_filtering_MAC.sh'
           '${vcf_input}'
            '${vcf_input.element_identifier}'
            '$MAC'
        
        ]]></command>
    
    <inputs>
        <param name="vcf_input" type="data" format="vcf" label="Upload your VCF file"
            help="File containing DNA sequence data in VCF format. You can upload a simple file, multiple files or a dataset collection"/>
        
        <param name="MAC" type="integer" value="2" min="0" label="Minimum number of Minor allele count per SNP (MIN_MAC)"
            help="Minimum number of minor alleles required for a locus to be retained."/>
    </inputs>

    <outputs>
        <data name="vcf_filtered" format="vcf" label="${tool.name}">
                <discover_datasets pattern="(?P&lt;designation&gt;.+)\.vcf" directory="vcf_filtered_directory" visible="true" assign_primary_output="true"/>
        </data>
        <data name="SNPs" from_work_dir="summary/n_snps.tabular" format="tabular" label="Filtering MAC : Number of SNPs"/>
    </outputs>

    <tests>
        <test>
            <param name="vcf_input" value="test_vcf.vcf"/>
            <param name="MAC" value="2"/>
            <output name="vcf_filtered">
                <discovered_dataset designation="test_vcf_MAC" file="test_vcf_MAC.vcf" ftype="vcf"/>
            </output>
            <output name="SNPs" file="summary/n_snps.tabular"/>
        </test>
    </tests>

        <help><![CDATA[
Usage
=====
As input, the user provides one or more VCF files (Danecek *et al.* 2011) and a threshold value indicating a minimum number of occurrences for the minor allele.
For each input VCF file, the tool calculates the minor allele count (MAC) for each variant, and removes those with a value below the user-defined threshold in the ouput file. 

Example: if MIN_MAC = 2, all variants having a minor allele observed fewer than 2 times in the input dataset  (MAC <2) are removed in the output VCF file.

Tips
====
Threshold values for minimum MAC depend on the study objectives and sample sizes.
For most types of analyses, a MIN_MAC of 2 is usually recommended. Other analyses might also keep singletons (occurence of 1 for the alternative allele) or apply a more stringent filtering (MIN_MAC of 4 or above, for metagenomics study, Hemstrom *et al.* 2024). 

See also examples of VCF formats in :  https://samtools.github.io/hts-specs/VCFv4.5.pdf

    ]]></help>

    <citations>
        <citation type="bibtex">
        @article{10.1093/gigascience/giab008,
    author = {Danecek, Petr and Bonfield, James K and Liddle, Jennifer and Marshall, John and Ohan, Valeriu and Pollard, Martin O and Whitwham, Andrew and Keane, Thomas and McCarthy, Shane A and Davies, Robert M and Li, Heng},
    title = "{Twelve years of SAMtools and BCFtools}",
    journal = {GigaScience},
    volume = {10},
    number = {2},
    year = {2021},
    abstract = "{SAMtools and BCFtools are widely used programs for processing and analysing high-throughput sequencing data. They include tools for file format conversion and manipulation, sorting, querying, statistics, variant calling, and effect analysis amongst other methods.The first version appeared online 12 years ago and has been maintained and further developed ever since, with many new features and improvements added over the years. The SAMtools and BCFtools packages represent a unique collection of tools that have been used in numerous other software projects and countless genomic pipelines.Both SAMtools and BCFtools are freely available on GitHub under the permissive MIT licence, free for both non-commercial and commercial use. Both packages have been installed \\&gt;1 million times via Bioconda. The source code and documentation are available from https://www.htslib.org.}",
    issn = {2047-217X},
    doi = {10.1093/gigascience/giab008},
    url = {https://doi.org/10.1093/gigascience/giab008},
    note = {giab008},
    eprint = {https://academic.oup.com/gigascience/article-pdf/10/2/giab008/36332246/giab008.pdf},
        }
        </citation>

        <citation type="bibtex">
            @article{hemstrom2024next,
  author={Hemstrom, William and Grummer, Jared A. and Luikart, Gordon and Beja-Pereira, Albano and Waples, Robin S. and Funk, W. Chris and Shafer, Aaron B. A. and Allendorf, Frederick W.},
  title={Next-generation data filtering in the genomics era},
  journal={Nature Reviews Genetics},
  volume={25},
  number={11},
  pages={750--767},
  year={2024},
  doi={10.1038/s41576-024-00738-6},
  url={https://doi.org/10.1038/s41576-024-00738-6}
}
        </citation>
        <citation type="bibtex">
            @article{Danecek2011,
  author          = {Danecek, Petr and Auton, Adam and Abecasis, Goncalo and Albers, Cornelis A. and Banks, Erica and DePristo, Mark A. and Handsaker, Robert E. and Lunter, Gerton and Marth, Gabor T. and Sherry, Stephen T. and McVean, Gil and Durbin, Richard and {1000 Genomes Project Analysis Group}},
  title           = {The variant call format and {VCF}tools},
  journal         = {Bioinformatics},
  volume          = {27},
  number          = {15},
  pages           = {2156-2158},
  year            = {2011},
  doi             = {10.1093/bioinformatics/btr330},
  URL             = {https://doi.org/10.1093/bioinformatics/btr330},
  eprint          = {https://academic.oup.com/bioinformatics/article-pdf/27/15/2156/600788/btr330.pdf},
}
        </citation>
    <citation type="bibtex">
        @manual{VCFv45,
  title        = {The Variant Call Format (VCF) Specification, Version 4.5},
  author       = {{HTS-specs team}},
  organization = {Global Alliance for Genomics and Health},
  year         = {2024},
  url          = {https://samtools.github.io/hts-specs/VCFv4.5.pdf},
  note         = {Accessed: 2025-02-11}
}
    </citation>
    </citations>
</tool>